# LINE Bot ç½æƒ…å›å ±æµç¨‹æ–‡ä»¶

> BOT-REPORT-001-05  
> ç‰ˆæœ¬ï¼š1.0  
> æ›´æ–°æ—¥æœŸï¼š2025-12-29

---

## ç›®éŒ„

1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [å°è©±æµç¨‹åœ–](#å°è©±æµç¨‹åœ–)
3. [ç‹€æ…‹æ©Ÿè¨­è¨ˆ](#ç‹€æ…‹æ©Ÿè¨­è¨ˆ)
4. [é—œéµå°è©±ç¯„ä¾‹](#é—œéµå°è©±ç¯„ä¾‹)
5. [éŒ¯èª¤è™•ç†ç¯„ä¾‹](#éŒ¯èª¤è™•ç†ç¯„ä¾‹)
6. [API è¦æ ¼](#api-è¦æ ¼)
7. [æŠ€è¡“æ¶æ§‹](#æŠ€è¡“æ¶æ§‹)

---

## åŠŸèƒ½æ¦‚è¿°

æœ¬ LINE Bot æä¾›ã€Œç½æƒ…å›å ±ã€åŠŸèƒ½ï¼Œé€éå¤šæ­¥é©Ÿå°è©±å¼•å°ç”¨æˆ¶å®Œæˆå®Œæ•´çš„ç½æƒ…å›å ±ï¼š

1. **ç™¼èµ·å›å ±** - ç”¨æˆ¶ç™¼é€ã€Œå›å ±ã€é—œéµå­—
2. **è¼¸å…¥æè¿°** - ç”¨æˆ¶æè¿°ç½æƒ…ç‹€æ³
3. **ä¸Šå‚³ç…§ç‰‡** - ç”¨æˆ¶ä¸Šå‚³ç¾å ´ç…§ç‰‡ï¼ˆå¯é¸ï¼‰
4. **åˆ†äº«ä½ç½®** - ç”¨æˆ¶åˆ†äº«ç½æƒ…ç™¼ç”Ÿåœ°é»
5. **ç¢ºèªé€å‡º** - ç³»çµ±ç¢ºèªä¸¦å»ºç«‹å›å ±è¨˜éŒ„

### æ”¯æ´çš„è§¸ç™¼é—œéµå­—

- `å›å ±`
- `ç½æƒ…`
- `é€šå ±`
- `å ±æ¡ˆ`

---

## å°è©±æµç¨‹åœ–

```mermaid
flowchart TD
    A[ä½¿ç”¨è€…ç™¼é€ã€Œå›å ±ã€] --> B[WAIT_TEXT<br/>è«‹æè¿°ç½æƒ…]
    B -->|è¼¸å…¥æ–‡å­—| C[WAIT_IMAGE<br/>è«‹ä¸Šå‚³ç…§ç‰‡]
    B -->|ç™¼é€ã€Œå–æ¶ˆã€| X[å›å ±å–æ¶ˆ]
    C -->|ä¸Šå‚³åœ–ç‰‡| C
    C -->|ç™¼é€ã€Œè·³éã€æˆ–ã€Œå®Œæˆã€| D[WAIT_LOCATION<br/>è«‹åˆ†äº«ä½ç½®]
    C -->|ç™¼é€ã€Œå–æ¶ˆã€| X
    D -->|ç™¼é€ä½ç½®| E[CONFIRM<br/>ç¢ºèªå›å ±å…§å®¹]
    D -->|ç™¼é€ã€Œå–æ¶ˆã€| X
    E -->|ç™¼é€ã€Œç¢ºèªã€| F[å›å ±æˆåŠŸï¼<br/>å›å ±ç·¨è™Ÿï¼šXXXX]
    E -->|ç™¼é€ã€Œå–æ¶ˆã€| X
    F --> G[å›åˆ°ä¸€èˆ¬æ¨¡å¼]
    X --> G
```

---

## ç‹€æ…‹æ©Ÿè¨­è¨ˆ

### ç‹€æ…‹å®šç¾©

| ç‹€æ…‹ | èªªæ˜ | æ¥å—çš„äº‹ä»¶ |
|------|------|------------|
| `IDLE` | ç„¡é€²è¡Œä¸­çš„å›å ± | ã€Œå›å ±ã€é—œéµå­— |
| `WAIT_TEXT` | ç­‰å¾…ç½æƒ…æè¿° | æ–‡å­—è¨Šæ¯ |
| `WAIT_IMAGE` | ç­‰å¾…ç…§ç‰‡ä¸Šå‚³ | åœ–ç‰‡è¨Šæ¯ã€ã€Œè·³éã€ã€ã€Œå®Œæˆã€ |
| `WAIT_LOCATION` | ç­‰å¾…ä½ç½®è³‡è¨Š | ä½ç½®è¨Šæ¯ |
| `CONFIRM` | ç­‰å¾…ç¢ºèªé€å‡º | ã€Œç¢ºèªã€ã€ã€Œå–æ¶ˆã€ |
| `SUBMITTED` | å·²é€å‡º | - |

### é€šç”¨æŒ‡ä»¤

ä»»ä½•ç‹€æ…‹ä¸‹çš†å¯ä½¿ç”¨ï¼š
- `å–æ¶ˆ` / `çµæŸ` / `æ”¾æ£„` - å–æ¶ˆå›å ±æµç¨‹

---

## é—œéµå°è©±ç¯„ä¾‹

### 1. å®Œæ•´æˆåŠŸæµç¨‹

```text
ğŸ‘¤ ç”¨æˆ¶ï¼šå›å ±

ğŸ¤– æ©Ÿå™¨äººï¼š
ğŸš¨ é–‹å§‹ç½æƒ…å›å ±

è«‹æè¿°æ‚¨çœ‹åˆ°çš„ç½æƒ…ç‹€æ³ï¼š
ï¼ˆä¾‹ï¼šã€Œè·¯æ¨¹å€’å¡Œé˜»æ“‹é“è·¯ã€ï¼‰

ğŸ’¡ è¼¸å…¥ã€Œå–æ¶ˆã€å¯éš¨æ™‚çµ‚æ­¢å›å ±

---

ğŸ‘¤ ç”¨æˆ¶ï¼šæ°‘ç”Ÿæ±è·¯äºŒæ®µæœ‰é›»ç·šæ¡¿å€’å¡Œï¼Œå½±éŸ¿äº¤é€š

ğŸ¤– æ©Ÿå™¨äººï¼š
ğŸ“ å·²è¨˜éŒ„ç½æƒ…æè¿°ï¼

è«‹ä¸Šå‚³ç¾å ´ç…§ç‰‡ï¼š
ï¼ˆé»æ“Šã€Œ+ã€â†’ã€Œç›¸ç°¿ã€æˆ–ã€Œç›¸æ©Ÿã€ï¼‰

ğŸ’¡ è¼¸å…¥ã€Œè·³éã€å¯ç•¥éç…§ç‰‡ä¸Šå‚³

---

ğŸ‘¤ ç”¨æˆ¶ï¼š[ä¸Šå‚³ä¸€å¼µç…§ç‰‡]

ğŸ¤– æ©Ÿå™¨äººï¼š
ğŸ“· å·²æ”¶åˆ°ç…§ç‰‡ï¼

å¯ç¹¼çºŒä¸Šå‚³æ›´å¤šç…§ç‰‡ï¼Œæˆ–è¼¸å…¥ã€Œå®Œæˆã€é€²å…¥ä¸‹ä¸€æ­¥

---

ğŸ‘¤ ç”¨æˆ¶ï¼šå®Œæˆ

ğŸ¤– æ©Ÿå™¨äººï¼š
ğŸ“ æ¥ä¸‹ä¾†è«‹åˆ†äº«ä½ç½®ï¼š

é»æ“Šã€Œ+ã€â†’ã€Œä½ç½®è³‡è¨Šã€
â†’ é¸æ“‡ç½æƒ…ç™¼ç”Ÿåœ°é»

---

ğŸ‘¤ ç”¨æˆ¶ï¼š[åˆ†äº«ä½ç½®ï¼šå°åŒ—å¸‚ä¸­å±±å€æ°‘ç”Ÿæ±è·¯äºŒæ®µ]

ğŸ¤– æ©Ÿå™¨äººï¼š
ğŸ“‹ è«‹ç¢ºèªå›å ±å…§å®¹ï¼š

ğŸ“ æè¿°ï¼šæ°‘ç”Ÿæ±è·¯äºŒæ®µæœ‰é›»ç·šæ¡¿å€’å¡Œï¼Œå½±éŸ¿äº¤é€š
ğŸ“· ç…§ç‰‡ï¼š1 å¼µ
ğŸ“ ä½ç½®ï¼šå°åŒ—å¸‚ä¸­å±±å€æ°‘ç”Ÿæ±è·¯äºŒæ®µ

å›è¦†ã€Œç¢ºèªã€é€å‡ºï¼Œæˆ–ã€Œå–æ¶ˆã€æ”¾æ£„

---

ğŸ‘¤ ç”¨æˆ¶ï¼šç¢ºèª

ğŸ¤– æ©Ÿå™¨äººï¼š
âœ… ç½æƒ…å›å ±å·²é€å‡ºï¼

å›å ±ç·¨è™Ÿï¼šA1B2C3D4

æˆ‘å€‘æœƒç›¡å¿«è™•ç†ï¼Œæ„Ÿè¬æ‚¨çš„å›å ±ï¼ğŸ™
```

### 2. è·³éç…§ç‰‡æµç¨‹

```text
ğŸ‘¤ ç”¨æˆ¶ï¼šå›å ±

ğŸ¤– æ©Ÿå™¨äººï¼šğŸš¨ é–‹å§‹ç½æƒ…å›å ±...

ğŸ‘¤ ç”¨æˆ¶ï¼šè·¯é¢æœ‰å¤§å‘æ´ï¼Œè»Šè¼›ç¶“éå¾ˆå±éšª

ğŸ¤– æ©Ÿå™¨äººï¼šğŸ“ å·²è¨˜éŒ„ç½æƒ…æè¿°ï¼è«‹ä¸Šå‚³ç¾å ´ç…§ç‰‡...

ğŸ‘¤ ç”¨æˆ¶ï¼šè·³é

ğŸ¤– æ©Ÿå™¨äººï¼šğŸ“ æ¥ä¸‹ä¾†è«‹åˆ†äº«ä½ç½®...

[æ¥çºŒä½ç½®åˆ†äº«èˆ‡ç¢ºèªæµç¨‹]
```

---

## éŒ¯èª¤è™•ç†ç¯„ä¾‹

### 1. WAIT_TEXT ç‹€æ…‹è¼¸å…¥å¤ªçŸ­

```text
ğŸ‘¤ ç”¨æˆ¶ï¼šå›å ±

ğŸ¤– æ©Ÿå™¨äººï¼šğŸš¨ é–‹å§‹ç½æƒ…å›å ±...

ğŸ‘¤ ç”¨æˆ¶ï¼šå£äº†

ğŸ¤– æ©Ÿå™¨äººï¼šâ“ è«‹è¼¸å…¥æ–‡å­—æè¿°ç½æƒ…ç‹€æ³
```

### 2. WAIT_IMAGE ç‹€æ…‹ç™¼é€æ–‡å­—

```text
[åœ¨ç­‰å¾…ç…§ç‰‡ç‹€æ…‹]

ğŸ‘¤ ç”¨æˆ¶ï¼šæˆ‘ç¾åœ¨æ²’æœ‰ç…§ç‰‡

ğŸ¤– æ©Ÿå™¨äººï¼šâ“ è«‹ä¸Šå‚³ç…§ç‰‡æˆ–è¼¸å…¥ã€Œè·³éã€
```

### 3. WAIT_LOCATION ç‹€æ…‹ç™¼é€æ–‡å­—

```text
[åœ¨ç­‰å¾…ä½ç½®ç‹€æ…‹]

ğŸ‘¤ ç”¨æˆ¶ï¼šåœ¨æ°‘ç”Ÿæ±è·¯

ğŸ¤– æ©Ÿå™¨äººï¼š
â“ è«‹åˆ†äº«ä½ç½®è³‡è¨Š

é»æ“Šã€Œ+ã€â†’ã€Œä½ç½®è³‡è¨Šã€
```

### 4. ä¸­é€”å–æ¶ˆ

```text
[åœ¨ä»»ä½•ç‹€æ…‹]

ğŸ‘¤ ç”¨æˆ¶ï¼šå–æ¶ˆ

ğŸ¤– æ©Ÿå™¨äººï¼šâŒ å·²å–æ¶ˆç½æƒ…å›å ±
```

### 5. Session è¶…æ™‚

```text
[è¶…é 10 åˆ†é˜æœªæ“ä½œå¾Œ]

ğŸ‘¤ ç”¨æˆ¶ï¼š[ä»»ä½•è¨Šæ¯]

ğŸ¤– æ©Ÿå™¨äººï¼šâ° å›å ±å·²é€¾æ™‚ï¼ˆ10åˆ†é˜ï¼‰

è«‹é‡æ–°è¼¸å…¥ã€Œå›å ±ã€é–‹å§‹
```

---

## API è¦æ ¼

### POST /reportsï¼ˆå»ºç«‹å›å ±ï¼‰

**Request Bodyï¼š**

```json
{
    "type": "infrastructure",
    "severity": "medium",
    "title": "æ°‘ç”Ÿæ±è·¯äºŒæ®µæœ‰é›»ç·šæ¡¿å€’å¡Œï¼Œå½±éŸ¿äº¤é€š",
    "description": "æ°‘ç”Ÿæ±è·¯äºŒæ®µæœ‰é›»ç·šæ¡¿å€’å¡Œï¼Œå½±éŸ¿äº¤é€š",
    "latitude": 25.0565161,
    "longitude": 121.5451023,
    "address": "å°åŒ—å¸‚ä¸­å±±å€æ°‘ç”Ÿæ±è·¯äºŒæ®µ",
    "photos": [
        "https://storage.googleapis.com/light-keepers-reports/reports/U123456/1703817600_abc123.jpg"
    ],
    "contactName": "ç‹å°æ˜"
}
```

**Responseï¼š**

```json
{
    "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
    "type": "infrastructure",
    "status": "pending",
    "createdAt": "2025-12-29T08:30:00.000Z"
}
```

### Webhook äº‹ä»¶æ ¼å¼

**Text Messageï¼š**

```json
{
    "type": "message",
    "replyToken": "xxxxxxxx",
    "source": {
        "type": "user",
        "userId": "U1234567890abcdef"
    },
    "message": {
        "type": "text",
        "id": "12345678901234",
        "text": "å›å ±"
    }
}
```

**Image Messageï¼š**

```json
{
    "type": "message",
    "replyToken": "xxxxxxxx",
    "source": {
        "type": "user",
        "userId": "U1234567890abcdef"
    },
    "message": {
        "type": "image",
        "id": "12345678901234",
        "contentProvider": {
            "type": "line"
        }
    }
}
```

**Location Messageï¼š**

```json
{
    "type": "message",
    "replyToken": "xxxxxxxx",
    "source": {
        "type": "user",
        "userId": "U1234567890abcdef"
    },
    "message": {
        "type": "location",
        "id": "12345678901234",
        "latitude": 25.0565161,
        "longitude": 121.5451023,
        "address": "å°åŒ—å¸‚ä¸­å±±å€æ°‘ç”Ÿæ±è·¯äºŒæ®µ"
    }
}
```

---

## æŠ€è¡“æ¶æ§‹

### ç›®éŒ„çµæ§‹

```
backend/src/modules/line-bot/
â”œâ”€â”€ line-bot.controller.ts      # Webhook å…¥å£èˆ‡äº‹ä»¶åˆ†æ´¾
â”œâ”€â”€ line-bot.service.ts         # LINE API æ“ä½œ
â”œâ”€â”€ line-bot.module.ts          # æ¨¡çµ„å®šç¾©
â”‚
â””â”€â”€ disaster-report/            # ç½æƒ…å›å ±å­æ¨¡çµ„
    â”œâ”€â”€ disaster-report.service.ts       # ç‹€æ…‹æ©Ÿæ§åˆ¶
    â”œâ”€â”€ session-state.service.ts         # Session ç®¡ç†
    â”œâ”€â”€ image-upload.service.ts          # åœ–ç‰‡ä¸Šå‚³
    â”œâ”€â”€ disaster-report.types.ts         # å‹åˆ¥å®šç¾©
    â”œâ”€â”€ disaster-report.constants.ts     # å¸¸æ•¸èˆ‡è¨Šæ¯
    â””â”€â”€ index.ts                         # å°å‡º
```

### ç‹€æ…‹å­˜å„²

ç›®å‰ä½¿ç”¨è¨˜æ†¶é«”å­˜å„² Sessionï¼Œé©ç”¨æ–¼å–®å¯¦ä¾‹éƒ¨ç½²ã€‚

å¦‚éœ€å¤šå¯¦ä¾‹éƒ¨ç½²ï¼Œå¯é·ç§»è‡³ï¼š
- **Firestore** - æ¨è–¦ï¼Œç„¡ä¼ºæœå™¨æ¶æ§‹
- **Redis** - è¶…ä½å»¶é²

### åœ–ç‰‡è™•ç†æµç¨‹

1. LINE ç™¼é€ image message åˆ° webhook
2. å¾Œç«¯ä½¿ç”¨ `LINE_CHANNEL_ACCESS_TOKEN` ä¸‹è¼‰åœ–ç‰‡
3. ä¸Šå‚³è‡³ Google Cloud Storage
4. è¿”å›å…¬é–‹ URL å­˜å…¥ Session

### å®‰å…¨æ€§

- **ç°½ç« é©—è­‰**ï¼šä½¿ç”¨ `X-Line-Signature` é©—è­‰è«‹æ±‚ä¾†æº
- **Session éæœŸ**ï¼š10 åˆ†é˜è‡ªå‹•éæœŸ
- **åœ–ç‰‡å­˜å–**ï¼šCloud Storage å¯è¨­å®šç‚ºç§æœ‰ + ç°½å URL

---

## ç’°å¢ƒè®Šæ•¸

| è®Šæ•¸åç¨± | èªªæ˜ | ç¯„ä¾‹ |
|----------|------|------|
| `LINE_CHANNEL_ACCESS_TOKEN` | Messaging API Access Token | `xxxxx...` |
| `LINE_CHANNEL_SECRET` | Channel Secretï¼ˆç°½ç« é©—è­‰ï¼‰ | `xxxxx...` |
| `GCS_BUCKET_NAME` | Cloud Storage Bucket åç¨± | `light-keepers-reports` |

---

## æ¸¬è©¦æŒ‡å—

### å–®å…ƒæ¸¬è©¦ç­–ç•¥

```typescript
// session-state.service.spec.ts
describe('SessionStateService', () => {
    it('should create new session with WAIT_TEXT state', async () => {
        const session = await service.createSession('U123', 'Test User');
        expect(session.state).toBe(ReportSessionState.WAIT_TEXT);
    });

    it('should return null for expired session', async () => {
        // è¨­å®šéæœŸæ™‚é–“ç‚ºéå»
        const session = await service.getSession('U123');
        expect(session).toBeNull();
    });
});
```

### æ•´åˆæ¸¬è©¦

```bash
# ç™¼é€æ¨¡æ“¬ webhook äº‹ä»¶
curl -X POST https://api.lightkeepers.ngo/line-bot/webhook \
  -H "Content-Type: application/json" \
  -H "X-Line-Signature: [valid-signature]" \
  -d '{
    "events": [{
      "type": "message",
      "replyToken": "test",
      "source": { "type": "user", "userId": "U123" },
      "message": { "type": "text", "id": "1", "text": "å›å ±" }
    }]
  }'
```
