# Emergency Response åŒæ­¥/é›¢ç·š/é‡ç½®ç­–ç•¥

**æ–‡ä»¶ç·¨è™Ÿ**ï¼š07  
**ç‰ˆæœ¬**ï¼š1.0

---

## 1. åŒæ­¥ç­–ç•¥

### 1.1 æ­£å¸¸æ¨¡å¼ï¼ˆOnlineï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     WebSocket     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontendâ”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ Backend â”‚
â”‚         â”‚   å³æ™‚æ¨æ’­æ›´æ–°     â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **WebSocket** æ¨æ’­ï¼šKPIã€è­¦ç¤ºã€äº‹ä»¶ã€ä»»å‹™æ›´æ–°
- **React Query** å¿«å–ï¼š5 ç§’ stale time

### 1.2 é™ç´šæ¨¡å¼ï¼ˆDegradedï¼‰

ç•¶ WebSocket æ–·ç·šä½† HTTP ä»å¯ç”¨ï¼š

```typescript
// React Query è¨­å®š
useQuery({
  queryKey: ['kpi', sessionId],
  queryFn: fetchKpi,
  refetchInterval: 30000, // 30 ç§’è¼ªè©¢
  staleTime: 5000,
})
```

- **é¡¯ç¤º**ï¼šã€Œâš ï¸ Degradedã€é»ƒè‰²æŒ‡ç¤ºç‡ˆ
- **è¼ªè©¢é »ç‡**ï¼š30 ç§’
- **è¡Œç‚º**ï¼šä»å¯è®€å¯«

### 1.3 é›¢ç·šæ¨¡å¼ï¼ˆOfflineï¼‰

å®Œå…¨æ–·ç·šï¼š

- **é¡¯ç¤º**ï¼šã€ŒğŸ”´ Offlineã€ç´…è‰²æŒ‡ç¤ºç‡ˆ + æœ€å¾ŒåŒæ­¥æ™‚é–“
- **å¯è®€**ï¼šlocalStorage/IndexedDB å¿«ç…§
- **ç¦å¯«**ï¼šç¦ç”¨æœƒå¯«å…¥ä¼ºæœå™¨çš„æ“ä½œï¼Œé¡¯ç¤º Toast æç¤º
- **ä¾‹å¤–**ï¼šå¯ç€è¦½é å¿«å–çš„æ‰‹å†Šèˆ‡ SOP

---

## 2. é›¢ç·šå¿«å–ç­–ç•¥ï¼ˆPWAï¼‰

### 2.1 é å¿«å–ï¼ˆPrecacheï¼‰

| è³‡æº | ç­–ç•¥ |
|------|------|
| App Shellï¼ˆHTML/CSS/JSï¼‰ | CacheFirst |
| æ‰‹å†Šå…§å®¹ | StaleWhileRevalidate |
| éœæ…‹åœ–ç‰‡/Icon | CacheFirst |

### 2.2 åŸ·è¡ŒæœŸå¿«å–ï¼ˆRuntimeï¼‰

| è³‡æº | ç­–ç•¥ |
|------|------|
| API `/api/er/sessions/:id/kpi` | NetworkFirst |
| API å…¶ä»– | NetworkOnly |

### 2.3 Dashboard å¿«ç…§

```typescript
// æ¯æ¬¡ KPI æ›´æ–°æ™‚å­˜å…¥ IndexedDB
const saveSnapshot = async (sessionId: string, data: KpiData) => {
  await idb.put('dashboard-snapshots', { sessionId, data, timestamp: Date.now() });
};
```

---

## 3. é‡ç½®ç­–ç•¥

### 3.1 é‡ç½®é¸é …

| é¸é … | èªªæ˜ |
|------|------|
| ç«‹å³æ¸…é™¤ | åˆªé™¤æ‰€æœ‰ Session Data |
| ä¿ç•™ N å¤© | è¨­å®šè‡ªå‹•æ¸…é™¤æ’ç¨‹ |
| åŒ¿ååŒ–ä¿ç•™ | ç§»é™¤å€‹è³‡ï¼Œä¿ç•™çµ±è¨ˆ |
| åƒ…ä¿ç•™æ‘˜è¦ | åˆªé™¤æ˜ç´°ï¼Œä¿ç•™å ±è¡¨ |

### 3.2 å®‰å…¨æ©Ÿåˆ¶

1. **äºŒæ¬¡ç¢ºèª**ï¼šå½ˆçª—ç¢ºèª
2. **è¼¸å…¥ä»»å‹™ä»£ç¢¼**ï¼šéœ€è¼¸å…¥ `ER-2026-001` ç¢ºèª
3. **ä¸å¯é€†æç¤º**ï¼šæ˜ç¢ºå‘ŠçŸ¥è³‡æ–™å°‡æ°¸ä¹…åˆªé™¤
4. **ç¨½æ ¸æ—¥èªŒ**ï¼šè¨˜éŒ„æ“ä½œè€…ã€æ™‚é–“ã€å½±éŸ¿ç¯„åœ

### 3.3 æ¸…é™¤ç¯„åœ

```
âœ“ æ¸…é™¤ï¼ševents, tasks, reports, inventory_txns, map_markers
âœ— ä¸å‹•ï¼švolunteers, resources, manuals, users
```

---

## 4. è¡çªç­–ç•¥

æ¡ç”¨ **Server Authoritative**ï¼š

- ä¼ºæœå™¨è³‡æ–™ç‚ºæœ€çµ‚æ¬Šå¨
- é›¢ç·šæœŸé–“è‹¥æœ‰è¡çªï¼Œä»¥ä¼ºæœå™¨ç‰ˆæœ¬è¦†è“‹
- è¡çªç™¼ç”Ÿæ™‚é¡¯ç¤º Toast é€šçŸ¥ä½¿ç”¨è€…
