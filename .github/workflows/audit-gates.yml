name: audit-gates

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: audit-gates-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"

jobs:
  # Stage-1: Static analysis (no secrets needed)
  static:
    name: "Proof Pipeline (Static)"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install Backend Dependencies
        working-directory: backend
        run: npm ci --legacy-peer-deps

      - name: Build Backend
        working-directory: backend
        run: npm run build

      # SSOT Duplicate Detection (must run first)
      - name: Detect SSOT Duplicates
        shell: pwsh
        run: |
          pwsh tools/audit/detect-ssot-duplicates.ps1

      # Domain Map SSOT (Generate metadata - deterministic)
      - name: Generate Domain Map (SSOT metadata)
        shell: pwsh
        run: |
          pwsh tools/audit/generate-domain-map.ps1

      # T0: Baseline Scan
      - name: Run Baseline Scan (T0)
        shell: pwsh
        run: |
          pwsh tools/audit/scan-baseline.ps1

      # T9: App Guard Registration Report
      - name: Generate App Guard Report (T9)
        shell: pwsh
        run: |
          pwsh tools/audit/generate-app-guard-report.ps1

      # T1a: Route-Guard Mapping
      - name: Run Route-Guard Mapping (T1a)
        shell: pwsh
        run: |
          pwsh tools/audit/scan-routes-guards.ps1 -ProductionMode

      # Domain Map Reference Check (soft on PR)
      - name: Run Domain Map Check (T0d - G6)
        shell: pwsh
        run: |
          pwsh tools/audit/check-domain-map.ps1

      # Generate public-surface.md from SSOT
      - name: Generate Public Surface Markdown (SSOT -> md)
        shell: pwsh
        run: |
          pwsh tools/audit/generate-public-surface-md.ps1

      # Public Surface Validation
      - name: Validate Public Surface
        shell: pwsh
        run: |
          pwsh tools/audit/validate-public-surface.ps1

      # CI Gate Check (PR = non-strict)
      - name: CI Gate Check (PR Non-Strict)
        if: github.event_name == 'pull_request'
        shell: pwsh
        run: |
          pwsh tools/audit/ci-gate-check.ps1

      # CI Gate Check (main = strict, blocks merge)
      - name: CI Gate Check (Main Strict)
        if: github.ref == 'refs/heads/main'
        shell: pwsh
        run: |
          pwsh tools/audit/ci-gate-check.ps1 -Strict

      # Negative Test Gate - Verify that strict mode actually fails on bad data (main only)
      - name: Self-Test Gate (Negative Test)
        if: github.ref == 'refs/heads/main'
        shell: pwsh
        run: |
          pwsh tools/audit/selftest-ci-gate.ps1

      # Generate Proof Documents from SSOT
      - name: Generate Proof Index (SSOT -> index.md)
        shell: pwsh
        run: |
          pwsh tools/audit/generate-proof-index.ps1

      - name: Generate Traceability (SSOT -> traceability.md)
        shell: pwsh
        run: |
          pwsh tools/audit/generate-traceability.ps1

      - name: Generate Walkthrough (Evidence-First, AUTO)
        shell: pwsh
        run: |
          pwsh tools/audit/generate-walkthrough.ps1

      - name: Export Stack Versions (SSOT)
        shell: pwsh
        run: |
          pwsh tools/audit/export-stack-versions.ps1

      - name: Count Frontend Pages (SSOT)
        shell: pwsh
        run: |
          pwsh tools/audit/count-frontend-pages.ps1

      # Drift Lock (proof docs - WARNING only due to Windows/Linux encoding differences)
      # NOTE: Windows generates UTF-8 with BOM, Linux generates UTF-8 without BOM.
      # Dynamic fields (timestamps, commit SHA) also differ between local and CI.
      # The authoritative gates have already passed at this point, so drift check is informational.
      - name: Drift Lock (proof docs)
        shell: bash
        continue-on-error: true
        run: |
          git diff --exit-code \
            docs/proof/index.md \
            docs/proof/traceability.md \
            docs/proof/audit/walkthrough.md \
            docs/proof/security/public-surface.md || \
            (echo "WARNING: Proof documents differ from committed versions. This is expected due to encoding/timestamp differences." && exit 0)

      # Publish gate summary to job summary
      - name: Publish gate summary to job summary
        if: always()
        shell: bash
        run: |
          echo "## CI Gate Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f docs/proof/gates/gate-summary.md ]; then
            cat docs/proof/gates/gate-summary.md >> $GITHUB_STEP_SUMMARY
          else
            echo "gate-summary.md not found" >> $GITHUB_STEP_SUMMARY
          fi

      # Upload artifacts for review (complete audit pack)
      - name: Upload Proof Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: proof-artifacts
          path: |
            docs/proof/index.md
            docs/proof/traceability.md
            docs/proof/gates/**
            docs/proof/logs/**
            docs/proof/security/**
            docs/proof/api/**
            docs/proof/audit/**
          retention-days: 30

  # Stage-2: Smoke tests (main branch only, requires secrets)
  smoke:
    runs-on: ubuntu-latest
    name: "Proof Pipeline (Smoke)"
    needs: static
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install Backend Dependencies
        working-directory: backend
        run: npm ci --legacy-peer-deps

      - name: Build Backend
        working-directory: backend
        run: npm run build

      # Smoke Test (optional - requires SMOKE_BASE_URL secret)
      - name: Smoke Authorization Tests
        if: always()
        shell: pwsh
        env:
          SMOKE_BASE_URL: ${{ secrets.SMOKE_BASE_URL }}
        run: |
          if ($env:SMOKE_BASE_URL) {
            pwsh tools/audit/smoke-authz.ps1 -BaseUrl $env:SMOKE_BASE_URL
          } else {
            Write-Host "SMOKE_BASE_URL not set, skipping smoke tests"
          }

      # Upload smoke artifacts
      - name: Upload Smoke Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-artifacts
          path: |
            docs/proof/**
          retention-days: 30
